了解CDN缓存，先得知道什么是CDN，CDN是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN的关键技术主要有内容存储和分发技术(较为官方的说明)。

之前看到一个不错的例子，这里直接拿过来举例说说CDN。

假设多年前我们所在的城市只有一个火车站，每次春运，整个城市的人都得去这个火车站买票，人流量以及购票的需求可想而知有多大，为了缓解这个问题，城市的不同区，都出现了火车票代售点，这样每个区的人都可以就近买票了，火车站总站的压力就这样大大减轻了。

我们可以把每个区的售票点称之为CDN节点，也就是前面所说的代理服务器。简而言之，我们可以把CDN理解成浏览器与服务器之间的临时站点，它会替服务器处理一部分的浏览器请求，从而整理减轻总服务器的压力。

我们可以把CDN的价值归纳为：CDN通过分流的形式，大大减轻源站的访问压力。


# 简述CDN过程

CDN边缘节点缓存数据，当浏览器请求，CDN将代替源站判断并处理此处请求。

```
日常请求对话

第一次请求

浏览器：服务器老哥，我需要a.js.

服务器：（恼羞成怒）文件我给我小弟CDN了，以后你要这个找CDN，别找我了。成功返回a.js给CDN，CDN进行缓存，同时CDN返回给浏览器，浏览器自己也进行了缓存(cache-control的值public就是用在这的)。

后续请求...

浏览器：服务器，我缓存时间到了，赶紧给我对比下文件，看看要不要重新返回给我。

CDN节点：打住打住，叫唤啥呢，我大哥比较忙，文件给我看看，请求被代理了。

情况1：CDN节点自己缓存的文件未过期，于是返回了304给浏览器，打回了这次请求。

情况2：CDN节点发现自己缓存的文件过期了，为了保险起见，自己发起请求给了服务器(源站)，成功拿回了最新数据，然后再交给与了浏览器。
```

其实说到这，CDN缓存的问题也跟前面的http缓存一样，CDN缓存时间不过期，浏览器始终被拦截，无法拿到最新的文件。

但是我们回归http缓存问题本质，缓存本身针对于更新频率不高的静态文件，其次，CDN缓存提供了分流以及访问加速其它优势条件。CDN类似一个平台，是可以通过登录，手动更新CDN缓存的，变相解决了浏览器缓存无法手动控制的问题。

<br>

# 详解CDN过程

### 加入CDN前
用户通过浏览器等方式访问网站的过程如图所示：

![image](https://user-images.githubusercontent.com/74364990/110273317-4e32a380-8007-11eb-9139-8bc0d9bc45bb.png)


（1）用户在自己的浏览器中输入要访问的网站域名。

（2）浏览器向 `本地DNS服务器` 请求对该域名的解析。

（3）本地DNS服务器中如果缓存有这个域名的解析结果，则直接响应用户的解析请求。

（4）本地DNS服务器中如果没有关于这个域名的解析结果的缓存，则以递归方式向整个DNS系统请求解析，获得应答后将结果反馈给浏览器。

（5）浏览器得到域名解析结果，就是该域名相应的服务设备的 `IP地址` 。

（6）浏览器向服务器请求内容。

（7）服务器将用户请求内容传送给浏览器。

<br>

### 加入CDN后

在网站和用户之间加入 CDN 以后，用户不会有任何与原来不同的感觉。最简单的 CDN 网络有一个 DNS 服务器和几台缓存服务器就可以运行了。一个典型的 CDN 用户访问调度流程如图所示:

![image](https://user-images.githubusercontent.com/74364990/110272673-b2546800-8005-11eb-82a1-bb4f535c87af.png)


（1）当用户点击网站页面上的内容URL，经过本地DNS系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 `CDN 专用 DNS 服务器`。

（2）CDN 的 DNS 服务器将 CDN 的全局负载均衡设备 IP 地址返回用户。

（3）用户向 CDN 的全局负载均衡设备发起内容 URL 访问请求。

（4）CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。

（5）基于以下这些条件的综合分析之后，区域负载均衡设备会向全局负载均衡设备返回一台缓存服务器的IP地址：
  - 根据用户 IP 地址，判断哪一台服务器距用户最近；
  - 根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需内容；
  - 查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。

（6）全局负载均衡设备把`服务器的 IP` 地址返回给用户。

（7）用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。


DNS 服务器根据用户 IP 地址，将域名解析成相应节点的缓存服务器IP地址，实现用户就近访问。

<br>


-----

详细见：[CDN详解](https://segmentfault.com/a/1190000010631404)
