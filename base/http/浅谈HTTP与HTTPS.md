
# 一、HTTP

- HTTP协议中的数据是利用TCP协议传输的
- HTTP是应用层协议，定义的是传输数据的内容的规范；

<br>

## HTTP报文

- 请求报文：

![image](https://user-images.githubusercontent.com/74364990/110167285-8207a080-7e30-11eb-8b0a-b18974d7fda6.png)

- 响应报文：

![image](https://user-images.githubusercontent.com/74364990/110167294-8633be00-7e30-11eb-9580-6e1ae7b60684.png)

<br>

## 浏览器输入URL后，依次涉及的协议

- DNS 服务：解析域名至对应的IP地址
- HTTP 协议：生成针对目标Web服务器的HTTP请求报文
- TCP 协议：将请求报文按序号分割成多个报文段
- IP 协议：搜索对方的地址，一边中转一边传送
- TCP 协议：按序号以原来的顺序重组请求报文请求的处理结果也同样利用TCP/IP协议向用户进行回传

![image](https://user-images.githubusercontent.com/74364990/110167848-4c16ec00-7e31-11eb-9c91-c7a10a9dcfd7.png)


<br>

# 二、HTTPS

在HTTP的基础上再加一层TLS（传输层安全性协议）或者SSL（安全套接层），就构成了HTTPS协议。

HTTPS 默认工作在 TCP 协议443端口，它的工作流程一般如以下方式：

（1）TCP 三次同步握手<br>
（2）客户端验证服务器数字证书<br>
（3）DH 算法协商对称加密算法的密钥、hash 算法的密钥<br>
（4）SSL 安全加密隧道协商完成<br>
（5）网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完整性保护，保证数据不被篡改。

![image](https://user-images.githubusercontent.com/74364990/110168388-16263780-7e32-11eb-8144-d0595e6c98cf.png)

- 客户端向服务端发送 `Client Hello` 消息，其中携带客户端支持的协议版本、加密算法、压缩算法以及客户端生成的随机数；
- 服务端收到客户端支持的协议版本、加密算法等信息后；
  - 向客户端发送 `Server Hello` 消息，并携带选择特定的协议版本、加密方法、会话 ID 以及服务端生成的随机数；
  - 向客户端发送 `Certificate` 消息，即服务端的证书链，其中包含证书支持的域名、发行方和有效期等信息；
  - 向客户端发送 `Server Key Exchange` 消息，传递公钥以及签名等信息；
  - 向客户端发送可选的消息 `Certificate Request`，验证客户端的证书；
  - 向客户端发送 `Server Hello Done` 消息，通知服务端已经发送了全部的相关信息；
- 客户端收到服务端的协议版本、加密方法、会话 ID 以及证书等信息后，验证服务端的证书；
  - 向服务端发送 `Client Key Exchange` 消息，包含使用服务端公钥加密后的随机字符串，即预主密钥（`Pre Master Secret`）；
  - 向服务端发送 `Change Cipher Spec` 消息，通知服务端后面的数据段会加密传输；
  - 向服务端发送 `Finished` 消息，其中包含加密后的握手信息；
- 服务端收到 `Change Cipher Spec` 和 `Finished` 消息后；
  - 向客户端发送 `Change Cipher Spec` 消息，通知客户端后面的数据段会加密传输；
  - 向客户端发送 `Finished` 消息，验证客户端的 `Finished` 消息并完成 TLS 握手；

TLS 握手的关键在于利用通信双发生成的随机字符串和服务端的证书公钥生成一个双方经过协商后的对称密钥，这样通信双方就可以使用这个对称密钥在后续的数据传输中加密消息数据，防止中间人的监听和攻击，保证通讯安全。

>HTTPS连接 需要7次握手，3次TCP + 4次TSL。


## 上面过程看不懂没关系，来个浅显易懂的：

![image](https://user-images.githubusercontent.com/74364990/110170548-53d88f80-7e35-11eb-9850-ce4e3f4a0d69.png)

**1、客户端发起HTTPS请求**
 
 这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。

**2、服务端的配置**<br>
 采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面(startssl就是个不错的选择，有1年的免费服务)。<br>
 这套证书其实就是一对公钥和私钥，如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。

**3、传送证书**<br>
 这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。
 
**4、客户端解析证书**<br>
 这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。<br>
 如果证书没有问题，那么就生成一个随机值，然后用证书对该随机值进行加密，就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。

**5、传送加密信息**<br>
 这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。

**6、服务段解密信息**<br>
 服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密，所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。
 
**7、传输加密后的信息**<br>
 这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。
 
**8、客户端解密信息**<br>
 客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容，整个过程第三方即使监听到了数据，也束手无策。

